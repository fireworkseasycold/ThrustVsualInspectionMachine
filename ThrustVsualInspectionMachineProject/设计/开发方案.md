# 超声波推力检测机 开发方案（结构化模板）

- 文档版本：v0.1（草稿，可持续迭代）
- 更新时间：${DATE}
- 负责人：待定（产品/架构/研发）
- 适用范围：ThrustVsualInspectionMachine（.NET 8 WPF + Prism + MahApps + SqlSugar + NLog）
- 关联文档：
  - 业务分析：设计/BusinessAnalysis.md
  - 设计说明：设计/DesignProject.md
  - 工程说明：项目根/README.md

---

## 1. 目标与范围
- 业务目标：构建一套稳定、可维护的超声波推力机视觉检测上位机，覆盖登录、主界面、参数配置、手动控制、报警清除、数据管理、配方、IO 监控等模块。
- 技术目标：
  - MVVM + Prism 模块化导航，统一风格（MahApps）
  - 可观测日志（NLog）、可配置（appsettings.json）、可扩展（Service/Repository 抽象）
  - 数据持久化（SqlSugar + SQLite/SQLServer 可切换）
- 非目标：算法实现细节、设备底层驱动开发、分布式高并发场景。

## 2. 业务需求基线（引用/映射）
- 用户与角色：操作员/工程师/厂商（权限分级）
- 页面清单（见 BusinessAnalysis.md 与 DesignProject.md）：
  1) 登录、开机欢迎 2) 主页 3) 厂家参数 4) 品控参数 5) 参数设定 6) 手动模式 7) 报警清除 8) 数据记录 9) 配方列表 10) IO 监控
- 显示与交互规范：蓝色主题、分栏布局与固定间距规范、关键操作确认提示。

## 3. 总体架构设计
- 客户端：WPF（.NET 8）+ Prism.Unity（IOC/导航/Region）+ MahApps（主题）
- 分层：
  - View（XAML）/ViewModel（命令与状态）/Service（业务）/Repository（数据）/Models（实体）
  - Core（领域模型与通用契约，netstandard2.0）
- 横切：日志（NLog）、配置（Microsoft.Extensions.Configuration）、国际化（Resources.resx）、异常处理（App.xaml.cs 统一兜底）。

## 4. 解决方案结构（现状与扩展）
- 现状（参考 README.md）
  - Views：ShellWindow, MainPage
  - ViewModels：ShellViewModel, MainViewModel
  - Services：ISampleRepository, SampleRepository（SqlSugar 示例）
  - Styles：主题与样式集合
- 扩展建议
  - 新增 Views/ViewModels：Login、Welcome、VendorParams、QualityParams、GeneralParams、ManualMode、AlarmClear、DataRecords、RecipeList、IOMonitor
  - 新增 Services：IAuthService、IRecipeService、IDataRecordService、IAlarmService、IIOMonitorService

## 5. 技术选型与关键版本
- .NET 8 WPF、Prism.Unity 9.x、MahApps.Metro 2.x
- Microsoft.Extensions.Configuration 9.x、SqlSugarCore 5.x、NLog 6.x
- SQLite/SQL Server 二选一（通过配置切换 DbType 与连接串）

## 6. 导航与区域设计（Prism）
- Regions：MainRegion（ShellWindow 主内容区）
- 页面键：Main、Login、Welcome、VendorParams、QualityParams、GeneralParams、ManualMode、AlarmClear、DataRecords、RecipeList、IOMonitor
- 导航流：
  - 启动 -> Welcome -> Login -> Main
  - Main 内根据操作进入各功能页（Back/Forward 基于 NavigationJournal）

## 7. UI 设计与页面规范
- 统一资源：App.xaml 合并 Styles 与 MahApps 主题字典
- 页面模板：
  - 命名：XxxPage.xaml + XxxViewModel.cs
  - 绑定：DataContext 由 Prism 自动映射或容器注入
  - 命令：ICommand + DelegateCommand，禁止在 CodeBehind 写业务
- 布局规范：左右分栏与固定间距（参考 DesignProject.md）

## 8. 权限与安全
- 简化 RBAC：Role = Operator/Engineer/Vendor
- 登录流程：AuthService 校验 -> IPrincipal 缓存 -> Prism EventAggregator 广播登录状态变更
- 页面访问控制：基于 Role 的导航守卫（自定义 IRegionNavigationContentLoader 或导航前校验）

## 9. 数据与存储（SqlSugar）
- 连接：读取 appsettings.json（Database:ConnectionString / DbType）
- 建表策略：启动时 EnsureCreated（示例），生产建议迁移脚本
- 初始表建议：
  - Users(Id, UserName, PasswordHash, Role, CreatedAt)
  - Recipes(Id, Name, ParamsJson, CreatedAt, UpdatedAt)
  - TestRecords(Id, RecipeId, Result, RawDataPath, CreatedAt)
  - Alarms(Id, Code, Message, Level, CreatedAt, ClearedAt)
- 实体与仓储：Models/* + Services/*Repository，统一接口与异常封装

## 10. 设备与 IO 集成（预留）
- 通讯抽象：IDeviceService（串口/以太网/现场总线），统一 Start/Stop/Read/Write
- IO 监控：采集频率、线程模型（Dispatcher/BackgroundService）、数据缓存（ConcurrentQueue）

## 11. 配置管理
- appsettings.json：
  - AppConfig、Database、Logging、FeatureFlags
- 读取与绑定：在 App.RegisterTypes 注入 IConfiguration 与强类型配置

## 12. 日志与异常
- NLog：文件 + 控制台 + 滚动策略，异常统一记录
- 全局异常：App.OnDispatcherUnhandledException、TaskScheduler.UnobservedTaskException

## 13. 国际化（I18N）
- 资源：Properties/Resources.resx + Resources.zh-CN.resx（待补充）
- 绑定：StaticResource 或 LocExtension（可引入第三方）

## 14. 性能与质量
- UI 性能：虚拟化长列表、异步加载、避免阻塞 UI 线程
- 内存：弱事件、解除订阅、IDisposable 模式
- 代码质量：xUnit + Moq 单测覆盖 ≥80%；代码风格 dotnet format

## 15. DevOps 与发布
- CI：GitHub Actions（build + test + artifact）
- 版本：SemVer；分支：main/dev/feature/*
- 发布：自定义安装包（后续可引入 Squirrel/MSIX）

## 16. 里程碑与迭代计划（示例）
- M1（第1-2周）：基础框架搭建、登录与主页
- M2（第3-4周）：参数模块（厂家/品控/通用）
- M3（第5-6周）：手动模式、报警清除、IO 监控
- M4（第7-8周）：数据记录、配方、导出报表
- M5（第9周）：性能优化、I18N、发布

## 17. 风险与对策
- 设备通讯不稳定 → 增加重连与缓冲策略
- 数据一致性 → 事务与重试、异常补偿
- UI 卡顿 → 严格异步化、分层缓存

## 18. 验收标准（示例）
- 核心流程可用：登录 -> 导航 -> 参数配置 -> 手动控制 -> 数据记录
- 崩溃率：< 0.1%（测试期）
- 性能：页面首开 < 1.5s、导航切换 < 300ms（测试环境）

## 19. 任务拆分（可勾选）
- [ ] 登录/权限（View/ViewModel/Service/存储）
- [ ] 主界面与导航（Region/Journal）
- [ ] 参数模块（三页）
- [ ] 手动模式与报警清除
- [ ] 数据记录与配方
- [ ] IO 监控
- [ ] 日志/异常/配置完善
- [ ] I18N 与性能优化
- [ ] 单元测试与CI

## 20. 变更与维护
- 变更流程：提出 -> 评审 -> 实施 -> 回归
- 文档维护：每次合并更新本方案版本与变更记录

---

## 附录：页面到文件命名映射建议

| 页面名称 | 建议文件名 | 所属模块 | 备注 |
|---------|------------|----------|------|
| 登录页面 | LoginView.xaml | Auth | 包含用户名密码输入和登录按钮 |
| 主仪表盘 | DashboardView.xaml | Dashboard | 实时数据显示和状态监控 |
| 测试配置 | TestConfigView.xaml | Test | 测试参数设置界面 |
| 实时监控 | RealTimeMonitorView.xaml | Monitor | 实时数据曲线和状态显示 |
| 历史数据 | HistoryDataView.xaml | Data | 历史记录查询和导出 |
| 报警管理 | AlarmManagementView.xaml | Alarm | 报警记录和处理 |
| 用户管理 | UserManagementView.xaml | System | 用户权限管理 |
| 系统设置 | SystemSettingsView.xaml | System | 系统参数配置 |
| PLC配置 | PlcConfigView.xaml | System | PLC通讯参数设置 |
| 关于页面 | AboutView.xaml | System | 系统信息和版本 |

---

## 填写指引

1. **目标与范围**：明确项目要解决的核心问题和交付边界
2. **业务需求基线**：参考BusinessAnalysis.md中的功能矩阵
3. **总体架构设计**：遵循DesignProject.md中的架构原则
4. **技术选型说明**：.NET 6+ WPF, Prism, MaterialDesign, SqlSugar, HslCommunication
5. **解决方案结构**：保持现有的分层架构模式
6. **页面导航设计**：使用Prism的Region导航机制
7. **数据存储方案**：SQLite本地数据库，考虑生产数据归档策略
8. **后续各章节**：按实际开发进度补充详细设计和实现方案

---

**文档状态**：初稿 ✅  
**最后更新**：${DATE}  
**版本**：v1.0